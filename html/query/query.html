<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Home - Brand</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,400i,700,700i,600,600i">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:100,100i,200,200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:300,400|Roboto:300,400,700">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:300,400|Roboto:300,400,700">
    <link rel="stylesheet" href="assets/fonts/simple-line-icons.min.css">
    <link rel="stylesheet" href="assets/css/Floating-Button.css">
    <link rel="stylesheet" href="assets/css/Floating-Up--Down-Animation.css">
    <link rel="stylesheet" href="assets/css/Highlight-Clean.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/baguettebox.js/1.10.0/baguetteBox.min.css">
    <link rel="stylesheet" href="assets/css/PHP-Contact-Form-dark-1.css">
    <link rel="stylesheet" href="assets/css/PHP-Contact-Form-dark.css">
    <link rel="stylesheet" href="assets/css/smoothproducts.css">
    <link rel="stylesheet" href="assets/css/sticky-dark-top-nav-with-dropdown.css">
    <link rel="stylesheet" href="assets/css/untitled-1.css">
    <link rel="stylesheet" href="assets/css/untitled.css">
    <link rel="stylesheet" href="assets/css/Wave-Animation-Circle-and-Square.css">
</head>

<body>
    <nav class="navbar navbar-light navbar-expand-lg fixed-top bg-white clean-navbar">
        <div class="container"><a class="navbar-brand logo" href="#">Hello</a><button data-toggle="collapse" data-target="#navcol-1" class="navbar-toggler"><span class="sr-only">Toggle navigation</span><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navcol-1">
                <div class="collapse navbar-collapse" id="navcol-1">
                    <ul class="navbar-nav nav-right">
                        <li class="nav-item"></li>
                        <li class="nav-item"></li>
                        <li class="nav-item"></li>
                        <li class="nav-item"></li>
                    </ul>
                    <p class="ml-auto navbar-text actions"> </p>
                </div>
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item"></li>
                    <li class="nav-item"><a class="nav-link active exit" id="btn_exit">退出登录</a></li>
                    <li class="nav-item"></li>
                    <li class="nav-item"></li>
                    <li class="nav-item"></li>
                </ul>
            </div>
        </div>
    </nav>
    <main class="page landing-page">
        <section class="clean-block clean-hero" style="background-image: url(&quot;./assets/img/sea.jpg&quot;);color: rgba(9, 162, 255, 0.15);height: 1000px;">
            <div id="contact-hidden_personal_set">
            </div>
            <div class="text">
                <h2 class="how_h2"><span class="obtain_info"></span>您好！&nbsp;</h2>
                <p class="intro">欢迎登录海洋海面高度数据开放平台&nbsp; &nbsp; &nbsp; 咨询人员界面</p><button class="btn btn-outline-light btn-lg" type="button"><a href="#jump">Search More</a></button>
            </div>
        </section>
        <section class="clean-block clean-info dark">
            <div class="container">
                <div class="block-heading" id="jump">
                    <div class="w-100 p-5">
                        <div class="wave-circle mx-auto my-5">
                            <div class="wave-effect"><span></span></div>
                        </div>
                    </div>
                    <h2 class="text-info" data-bss-hover-animate="shake">提供咨询服务</h2>
                    <p>if you're ready, please click here to do query service for visitorss&nbsp;</p><span class="span_now">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;NOW</span>
                </div>
                <div class="row align-items-center">
                    <div class="col-md-6"><img class="img-thumbnail" src="./assets/img/p2.png"></div>
                    <div class="col-md-6">
                        <h3>咨询服务介绍</h3>
                        <div class="getting-started-info">
                            <p>系统提供该接口用于咨询人员为平台到访者提供相应的专业知识<br>帮助其进行数据申请全流程指导<br>点击左下方按钮开始接受查询服务，点击右下方按钮暂停接收服务</p>
                        </div><button class="btn btn-outline-primary btn-lg query" type="button">Do Query Now</button> <button class="btn btn-outline-primary btn-lg stop_query" type="button">Stop Query</button>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <footer class="page-footer dark">
        <div class="container">
            <div class="row">
                <div class="col-sm-3">
                    <h5>Get started</h5>
                    <ul>
                        <li><a href="#">Home</a></li>
                        <li><a href="#">Sign up</a></li>
                        <li><a href="#">Downloads</a></li>
                    </ul>
                </div>
                <div class="col-sm-3">
                    <h5>About us</h5>
                    <ul>
                        <li><a href="#">Company Information</a></li>
                        <li><a href="#">Contact us</a></li>
                        <li><a href="#">Reviews</a></li>
                    </ul>
                </div>
                <div class="col-sm-3">
                    <h5>Support</h5>
                    <ul>
                        <li><a href="#">FAQ</a></li>
                        <li><a href="#">Help desk</a></li>
                        <li><a href="#">Forums</a></li>
                    </ul>
                </div>
                <div class="col-sm-3">
                    <h5>Legal</h5>
                    <ul>
                        <li><a href="#">Terms of Service</a></li>
                        <li><a href="#">Terms of Use</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="footer-copyright">
            <p>© 2021 Copyright 1853557 ZH_hhhh</p>
        </div>
    </footer>
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/bs-init.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/baguettebox.js/1.10.0/baguetteBox.min.js"></script>
    <script src="assets/js/smoothproducts.min.js"></script>
    <script src="assets/js/theme.js"></script>
    <script src="assets/js/PHP-Contact-Form-dark-1.js"></script>
    <script src="assets/js/PHP-Contact-Form-dark.js"></script>
    
</body>

<script src="assets/js/cryptico.js"></script>
<script src="assets/js/no_encrypty.js"></script>
<script>
    var query_no = parseInt(url_parser(window.location.search))

    /*初始时通过后端获取工作人员姓名信息 和综合评分*/
    function obtain_name()
    {
        $.ajax({
            type: 'post',
            url:"http://127.0.0.1:8000/user/api/",
            async: true,
            data:{
                action: "search_QueryAssist",
                no: query_no,
                no_op: query_no
            },
            datatype:'json',
        }).then(function(res){
            if(res['ret'] == 1){
                res_list = res['retlist']
                user_name = res_list[0]['name']
                $(".obtain_info").text(user_name + ' ')
                $(".obtain_info").css({
                    'color':'rgba(0,0,255,1)'
                })
            }
        }).catch(function(){
            alert("服务器暂无连接")
        })
    }
    obtain_name()


    /* 点击退出登录 退回到login界面 */
    $("#btn_exit").click(function(){
        window.location.replace("../login/login.html")
    })

    //获取今天的日期 返回字符串
    function get_cua_date()
    {
        var myDate = new Date()
        var year = myDate.getFullYear()
        var month = myDate.getMonth()+1
        var day = myDate.getDate()
        return year+"-"+month+"-"+day
    }

    $('#btn_exit').hover(function(){
        $(this).css("cursor","pointer")
    })

    var accept_query = 0   //全局变量表示接收咨询服务

    $(".query").click(function(){
        $.ajax({
            type: 'post',
            url:"http://127.0.0.1:8000/user/api/",
            async: false,
            data:{
                action: "update_QueryAssist",
                no: query_no,
                state: 1,
                no_op: query_no
            },
            datatype:'json',
            success: function(res){
                if(res['ret'] == 1){
                    alert("正在为您寻找相应访客，请稍等")
                    accept_query = 1
                    find_visitor()
                }
                else{
                    alert("服务器暂无连接")
                }
            },
            error: function(){
                alert("服务器暂无连接")
            }
        })
    })

    function sleep(interval)
    {
        return new Promise(resolve => {
            setTimeout(resolve, interval)
        })
    }

    // 匹配访客进行咨询
    async function find_visitor()
    {
        while(accept_query == 1){
            $.ajax({
                type: 'post',
                url:"http://127.0.0.1:8000/user/api/",
                async: false,
                data:{
                    action: "search_Communication",
                    cr_no: query_no,
                    cs_time: get_cua_date(),
                    no_op: query_no
                },
                datatype:'json',
                success: function(res){
                    if(res['ret'] == 1){
                        if(res['retlist'].length > 0){
                            // 将该人员的状态置为2 表示正忙
                            $.ajax({
                                type: 'post',
                                url:"http://127.0.0.1:8000/user/api/",
                                async: false,
                                data:{
                                    action: "update_QueryAssist",
                                    no: query_no,
                                    state: 2,
                                    no_op: query_no
                                },
                                datatype:'json',
                                success: function(res){
                                    if(res['ret'] != 1){
                                        alert("服务器暂无连接")
                                        return
                                    }
                                },
                                error: function(){
                                    alert("服务器暂无连接")
                                    return
                                }
                            })
                            // 新页面需要 发送者no 以及接收者no
                            window.location.assign(url_generate('../communication/communicate.html', [query_no, res['retlist'][0]['cs_no_id']]))
                        }
                    }
                    else{
                        alert("服务器暂无连接")
                    }
                },
                error: function(){
                    alert("服务器暂无连接")
                }
            })
            await sleep(3000)
        }
    }

    $(".stop_query").click(function(){
        $.ajax({
            type: 'post',
            url:"http://127.0.0.1:8000/user/api/",
            async: false,
            data:{
                action: "update_QueryAssist",
                no: query_no,
                state: 0,
                no_op: query_no
            },
            datatype:'json',
            success: function(res){
                if(res['ret'] == 1){
                    alert("已经暂停咨询服务，请您在做好准备后再次开始")
                    accept_query = 0
                }
                else{
                    alert("服务器暂无连接")
                }
            },
            error: function(){
                alert("服务器暂无连接")
            }
        })
    })

    

</script>
</html>