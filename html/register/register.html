<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>apply</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Arbutus+Slab">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:300,400|Roboto:300,400,700">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:300,400|Roboto:300,400,700">
    <link rel="stylesheet" href="assets/fonts/fontawesome-all.min.css">
    <link rel="stylesheet" href="assets/css/Animated-Text-Background.css">
    <link rel="stylesheet" href="assets/css/Continue-Button.css">
    <link rel="stylesheet" href="assets/css/Features-Blue.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <link rel="stylesheet" href="assets/css/sticky-dark-top-nav-with-dropdown.css">
    <link rel="stylesheet" href="assets/css/styles.css">
</head>

<body>
    <div class="d-flex justify-content-center align-items-center" id="animatedTextBackground">
        <nav class="navbar navbar-light navbar-expand-md navbar-fixed-top navigation-clean-button">
            <div class="container">
                <div><a class="navbar-brand" href="#"><span><img src="assets/img/logo.png"></span> </a><button data-toggle="collapse" class="navbar-toggler" data-target="#navcol-1"><span class="sr-only">Toggle navigation</span><span class="navbar-toggler-icon"></span></button></div>
                <div class="collapse navbar-collapse" id="navcol-1">
                    <ul class="navbar-nav nav-right">
                        <li class="nav-item"><a class="nav-link active">数据用途选择</a></li>
                        <li class="nav-item dropdown"><a class="dropdown-toggle nav-link" aria-expanded="false" data-toggle="dropdown" href="#">科研教育</a>
                            <div class="dropdown-menu"><a class="dropdown-item depart" no="0">气候变化研究（全球变暖、冰川和冰盖）</a><a class="dropdown-item depart" no="1">海洋学研究（海洋动力学和潮汐）</a><a class="dropdown-item depart" no="2">地质学研究（海岸线变化和沉积）</a><a class="dropdown-item depart" no="3">课堂教学</a></div>
                        </li>
                        <li class="nav-item dropdown"><a class="dropdown-toggle nav-link" aria-expanded="false" data-toggle="dropdown" href="#">商用用途</a>
                            <div class="dropdown-menu"><a class="dropdown-item depart" no="6">沿海开发和建设</a><a class="dropdown-item depart" no="7">保险业</a><a class="dropdown-item depart" no="8">海运和港口管理</a><a class="dropdown-item depart" no="9">开发商业应用程序</a></div>
                        </li>
                        <li class="nav-item dropdown"><a class="dropdown-toggle nav-link" aria-expanded="false" data-toggle="dropdown" href="#">个人用途</a>
                            <div class="dropdown-menu"><a class="dropdown-item depart" no="12">户外活动和旅游</a><a class="dropdown-item depart" no="13">个人决策制定</a><a class="dropdown-item depart" no="14">个人数据分析项目</a></div>
                        </li>
                        <li class="nav-item dropdown"><a class="dropdown-toggle nav-link" aria-expanded="false" data-toggle="dropdown" href="#">气象气候</a>
                            <div class="dropdown-menu"><a class="dropdown-item depart" no="15">天气预报</a><a class="dropdown-item depart" no="16">气候模型</a><a class="dropdown-item depart" no="17">洋流</a></div>
                        </li>
                        <li class="nav-item dropdown"><a class="dropdown-toggle nav-link" aria-expanded="false" data-toggle="dropdown" href="#">防灾减灾</a>
                            <div class="dropdown-menu"><a class="dropdown-item depart" no="18">海啸预警</a><a class="dropdown-item depart" no="19">风暴潮预警</a><a class="dropdown-item depart" no="20">沿海洪水风险管理</a><a class="dropdown-item depart" no="21">厄尔尼诺</a></div>
                        </li>
                    </ul>
                    <p class="ml-auto navbar-text actions"> <a class="btn btn-light action-button" role="button">Close</a></p>
                </div>
            </div>
        </nav>
        <h1 id="animatedTextHeading">Click To<br>Apply</h1>
        <section class="features-blue">
            <div class="container">
                <div class="intro doctor_info">
                    <h2 class="text-center" data-bss-hover-animate="shake">工作人员信息</h2>
                </div>
                <div class="row features">
                    <div class="col-sm-6 col-md-4 item __doc0" data-bss-hover-animate="jello" no_id=""><img class="img_doctor" no="0" src="./assets/img/p2.png">
                        <h3 class="name __docname0">专 家 姓 名</h3>
                        <p class="description __doctime0">时间：</p>
                        <p class="description __docprof0">职位：</p>
                        <p class="description __docmaxreg0">当前队列长度：</p>
                        <p class="description __doccurreg0">当前办理进度：</p><a class="btn btn-light action-button __docbtn" no="0" role="button">Apply Now</a>
                    </div>
                    <div class="col-sm-6 col-md-4 item __doc1" data-bss-hover-animate="jello" no_id=""><img class="img_doctor" no="1" src="./assets/img/p2.png">
                        <h3 class="name __docname1">专 家 姓 名</h3>
                        <p class="description __doctime1">时间：</p>
                        <p class="description __docprof1">职位：</p>
                        <p class="description __docmaxreg1">当前队列长度：</p>
                        <p class="description __doccurreg1">当前办理进度：</p><a class="btn btn-light action-button __docbtn" no="1" role="button">Apply Now</a>
                    </div>
                    <div class="col-sm-6 col-md-4 item __doc2" data-bss-hover-animate="jello" no_id=""><img class="img_doctor" no="2" src="./assets/img/p2.png">
                        <h3 class="name __docname2">专 家 姓 名</h3>
                        <p class="description __doctime2">时间：</p>
                        <p class="description __docprof2">职位：</p>
                        <p class="description __docmaxreg2">当前队列长度：</p>
                        <p class="description __doccurreg2">当前办理进度：</p><a class="btn btn-light action-button __docbtn" no="2" role="button">Apply Now</a>
                    </div>
                    <div class="col-sm-6 col-md-4 item __doc3" data-bss-hover-animate="jello" no_id=""><img class="img_doctor" no="3" src="./assets/img/p2.png">
                        <h3 class="name __docname3">专 家 姓 名</h3>
                        <p class="description __doctime3">时间：</p>
                        <p class="description __docprof3">职位：</p>
                        <p class="description __docmaxreg3">当前队列长度：</p>
                        <p class="description __doccurreg3">当前办理进度：</p><a class="btn btn-light action-button __docbtn" no="3" role="button">Apply Now</a>
                    </div>
                    <div class="col-sm-6 col-md-4 item __doc4" data-bss-hover-animate="jello" no_id=""><img class="img_doctor" no="4" src="./assets/img/p2.png">
                        <h3 class="name __docname4">专 家 姓 名</h3>
                        <p class="description __doctime4">时间：</p>
                        <p class="description __docprof4">职位：</p>
                        <p class="description __docmaxreg4">当前队列长度：</p>
                        <p class="description __doccurreg4">当前办理进度：</p><a class="btn btn-light action-button __docbtn" no="4" role="button">Apply Now</a>
                    </div>
                    <div class="col-sm-6 col-md-4 item __doc5" data-bss-hover-animate="jello" no_id=""><img class="img_doctor" no="5" src="./assets/img/p2.png">
                        <h3 class="name __docname5">专 家 姓 名</h3>
                        <p class="description __doctime5">时间：</p>
                        <p class="description __docprof5">职位：</p>
                        <p class="description __docmaxreg5">当前队列长度：</p>
                        <p class="description __doccurreg5">当前办理进度：</p><a class="btn btn-light action-button __docbtn" no="5" role="button">Apply Now</a>
                    </div>
                </div>
            </div>
        </section>
    </div>
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/bs-init.js"></script>
    <script src="assets/js/Animated-Text-Background.js"></script>
</body>
<script src="assets/js/cryptico.js"></script>
<script src="assets/js/no_encrypty.js"></script>
<script>

    // 获取当前用户账号信息 
    var user_no = parseInt(url_parser(window.location.search))

    var page_cnt = 0    //全局定义翻的页面个数 每个页面显示6个工作人员信息 每次从0开始
    var cur_depart_info

    function Init()
    {
        $(".navbar.navbar-light.navbar-expand-md.navbar-fixed-top.navigation-clean-button").css("display", "none")
        $(".features-blue").css("display", "none")
    }

    //根据传入的科室的字符串返回相关工作人员信息
    function obtain_doctor(depart)
    {
        var res_list
        $.ajax({
            type: 'post',
            url:"http://127.0.0.1:8000/user/api/",
            async: false,
            data:{
                action: "search_Staff",
                s_depart: depart,
                no_op: user_no
            },
            datatype:'json',
            success: function(res){
                res_list = res['retlist']
            },
            error: function(){
                alert("服务器暂无连接")
            }
        })

        // 将序列按照评分从大到小排序
        res_list.sort(function(a, b){
            return b['s_index'] - a['s_index']
        })
        return res_list
    }

    //获取今天的日期 返回字符串
    function get_cua_date()
    {
        var myDate = new Date()
        var year = myDate.getFullYear()
        var month = myDate.getMonth()+1
        var day = myDate.getDate()
        return year+"-"+month+"-"+day
    }

    //返回datetime类型字符串
    function get_cur_time()
    {
        var date = get_cua_date()
        var myDate = new Date()
        var hour = myDate.getHours()
        var minu = myDate.getMinutes()
        var sec = myDate.getSeconds()
        return date + " " + hour + ":" + minu + ":" + sec
    }

    //获取某个工作人员的当前最大挂号号码 
    function get_certain_doctor_max_register(doc_no)
    {
        var max_register_cnt = 0
        $.ajax({
            type: 'post',
            url:"http://127.0.0.1:8000/user/api/",
            async: false,
            data:{
                action: "search_Apply",
                a_date: get_cua_date(),
                a_no_staff: doc_no,
                no_op: user_no
            },
            datatype:'json',
            success:function(res){
                if(res['retlist'].length == 0)
                    max_register_cnt = 1;
                else
                    max_register_cnt = res['retlist'][res['retlist'].length-1]["a_index"]+1
            },
            error: function(){
                alert("服务器暂无连接")
            }
        })
        return max_register_cnt
    }

    //获取某个工作人员的当前到号号码
    function get_certain_doctor_cur_register(doc_no)
    {
        var cur_register
        $.ajax({
            type: 'post',
            url:"http://127.0.0.1:8000/user/api/",
            async: false,
            data:{
                action: "search_Current_Apply",
                a_date: get_cua_date(),
                a_no_staff: doc_no,
                no_op: user_no
            },
            datatype:'json',
            success:function(res){
                if(res['retlist'].length == 0)
                    cur_register = 0;
                else
                    cur_register = res['retlist'][res['retlist'].length-1]["a_index"]
            },
            error: function(){
                alert("服务器暂无连接")
            }
        })
        return cur_register
    }

    //获取某个工作人员的姓名 职称 就诊开始时间 就诊结束时间
    //doc_info [姓名，职称, 就诊开始时间，就诊结束时间]
    function get_certain_doctor_info(doc_no)
    {
        var doc_info = []
        $.ajax({
            type: 'post',
            url:"http://127.0.0.1:8000/user/api/",
            async: false,
            data:{
                action: "search_Staff",
                no: doc_no,
                no_op: user_no
            },
            datatype:'json',
            success:function(res){
                if(res['retlist'].length == 0)
                    alert("寻找工作人员信息出现错误")
                else{
                    doc_info.push(res['retlist'][0]['name'])
                    doc_info.push(res['retlist'][0]['s_profession'])
                    doc_info.push(res['retlist'][0]['s_time_begin'])
                    doc_info.push(res['retlist'][0]['s_time_end'])
                }
            },
            error: function(){
                alert("服务器暂无连接")
            }
        })
        return doc_info
    }

    function update_page(doc_list)
    {
        for(var i = 0; i < 6; i++){
            if(i + 6 * page_cnt >= doc_list.length){
                $(".__docname" + i).text("暂无工作人员信息")
                $(".__doc" + i).attr("no_id", "")
                $(".__docprof" + i).text("")
                $(".__doctime" + i).text("")
                $(".__docmaxreg" + i).text("")
                $(".__doccurreg" + i).text(" ")
                continue
            }
            var doc_no = doc_list[i + 6 * page_cnt]['no_id']
            
            // 获取姓名 职称 就诊时间 
            var doc_info = get_certain_doctor_info(doc_no)

            // 获取工作人员当前挂号最大数
            var doc_max_reg_cnt = get_certain_doctor_max_register(doc_no) - 1

            // 获取工作人员当前到号号码
            var doc_cur_reg_cnt = get_certain_doctor_cur_register(doc_no)

            // 更新该框内的工作人员账号信息
            $(".__doc" + i).attr("no_id", doc_no)

            // 更新工作人员姓名
            $(".__docname" + i).text(doc_info[0])

            // 更新工作人员职称
            $(".__docprof" + i).text("职称: " + doc_info[1])

            // 更新就诊时间
            $(".__doctime" + i).text("时间: " + doc_info[2] + ":00-" + doc_info[3] + ":00")

            // 更新当前挂号数
            $(".__docmaxreg" + i).text("当前挂号数: " + doc_max_reg_cnt)

            // 更新当前到号数
            $(".__doccurreg" + i).text("当前到号数: " + doc_cur_reg_cnt)
        }
    }

    // 初始化关闭所有提示框
    Init();

    //点击animatedTextBackground 弹出挂号选项导航栏
    $('#animatedTextBackground').click(function(){
        $(".navbar.navbar-light.navbar-expand-md.navbar-fixed-top.navigation-clean-button").fadeIn(1500)
    })



    // 上一页按钮按下 .btn.btn-primary.btn-sm.float-right.tenant-continue-btn.continue2
    $(".btn.btn-primary.btn-sm.float-right.tenant-continue-btn.continue2").click(function(){
        if(page_cnt > 0){
            // 更新
            page_cnt = page_cnt - 1
            doc_list = obtain_doctor(cur_depart_info)
            update_page(doc_list)
        }
    })

    // 下一页按钮按下 .btn.btn-primary.btn-sm.float-right.tenant-continue-btn.continue1
    $(".btn.btn-primary.btn-sm.float-right.tenant-continue-btn.continue1").click(function(){
        var doc_list = obtain_doctor(cur_depart_info)
        if((page_cnt + 1) * 6 < doc_list.length){
            page_cnt = page_cnt + 1
            update_page(doc_list)
        }
    })

    // 点击.btn.btn-light.action-button 关闭两个选项栏
    $(".btn.btn-light.action-button").click(function(){
        Init()
        page_cnt = 0
        cur_depart_info = ""
    })

    depart_name = ["气候变化研究（全球变暖、冰川和冰盖）", "海洋学研究（海洋动力学和潮汐）", "地质学研究（海岸线变化和沉积）", "课堂教学", 
                    "沿海开发和建设", "保险业", "海运和港口管理", "开发商业应用程序", 
                    "户外活动和旅游", "个人决策制定", "个人数据分析项目", 
                    "天气预报", "气候模型", "洋流", 
                    "海啸预警", "风暴潮预警", "沿海洪水风险管理", "厄尔尼诺"]

    $('.depart').click(function(){
        var index = $(this).attr('no')
        page_cnt = 0
        cur_depart_info = depart_name[index]
        doc_list = obtain_doctor(cur_depart_info)
        update_page(doc_list)
        $(".features-blue").fadeIn(1500)
    })

    // __docbtn按下进行挂号
    $(".__docbtn").click(function(){
        var index = $(this).attr('no')

        // 获取工作人员的no
        var doc_no = $(".__doc" + index).attr("no_id")

        if(doc_no == ""){
            alert("该工作人员不存在，无法挂号，请重试")
            return
        }
        else{
            var doc_max_reg_cnt = get_certain_doctor_max_register(doc_no)
            $.ajax({
                type: 'post',
                url:"http://127.0.0.1:8000/user/api/",
                async: true,
                data:{
                    action: "add_Apply",
                    a_no_staff: doc_no,
                    a_no_visitor: user_no,
                    a_index: doc_max_reg_cnt,
                    a_date: get_cua_date(),
                    no_op: user_no
                },
                datatype:'json',
            }).then(function(res){
                if(res['ret'] == 1){
                    alert("挂号成功，可在个人设置中查看当前到号信息")
                    window.location.assign(url_generate('../patient/patient.html', [user_no]))
                }
                else
                    alert("挂号失败，请稍后重试")
            }).catch(function(){
                alert("服务器暂无连接")
            })
        }
    })

    // 按下某个工作人员的信息框进入详细页面以供了解
    $(".img_doctor").click(function(){
        // 获取工作人员的no
        var doc_no = $(".__doc" + $(this).attr("no")).attr("no_id")
        if(doc_no != ""){
            window.open(url_generate('../doctor_info/doctor_info.html', [doc_no]))
        }
    })
    
    $(".img_doctor").hover(function(){
        $(this).css("cursor", "pointer")
    })

</script>

</html>